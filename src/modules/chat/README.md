# Chat Module

## Обзор

Модуль чата обеспечивает реал-тайм обмен сообщениями через WebSocket соединение.

## Автоматическая инициализация

WebSocket чата автоматически инициализируется после успешного получения профиля пользователя (`getProfile()`).

### Поток инициализации:

```
1. Пользователь входит в приложение
   ↓
2. Router middleware проверяет access_token в cookies
   ↓
3. Вызывается auth.getProfile()
   ↓
4. После успешного получения профиля автоматически вызывается chatStore.initializeWebSocket()
   ↓
5. WebSocket подключается к серверу с токеном из cookies
   ↓
6. Получаем событие "connected" и непрочитанные сообщения
```

## Файловая структура

```
chat/
├── api/
│   ├── index.ts              # Экспорт API
│   └── chat.api.ts           # HTTP API (загрузка файлов)
├── services/
│   └── websocket.service.ts  # WebSocket сервис
├── stores/
│   └── index.ts              # Pinia store для чата
├── types/
│   └── index.ts              # TypeScript типы
└── README.md                 # Эта документация
```

## Использование в компонентах

### Получение доступа к чату

```typescript
import { useChatStore } from '@/modules/chat/stores'

const chatStore = useChatStore()
```

### Отправка текстового сообщения

```typescript
await chatStore.sendTextMessage(userId, 'Привет!')
```

### Отправка файла/изображения

```typescript
await chatStore.sendFileMessage(userId, file, 4) // 4 = изображение
```

### Установка текущего чата

```typescript
chatStore.setCurrentChat(userId)
```

### Получение сообщений текущего чата

```typescript
const messages = computed(() => chatStore.currentChatMessages)
```

### Получение количества непрочитанных

```typescript
const unreadCount = computed(() => chatStore.unreadCount)
```

## Типы сообщений

- `1` - Текст
- `2` - Элемент (item)
- `3` - Видео
- `4` - Изображение
- `5` - Файл

## Статусы сообщений

- `1` - Непрочитанное (offline)
- `2` - Прочитанное/Доставленное

## WebSocket события

### От клиента к серверу:

- `private_message` - Отправка личного сообщения
- `ack` - Подтверждение получения сообщения
- `ping` - Heartbeat

### От сервера к клиенту:

- `connected` - Успешное подключение
- `new_message` - Новое входящее сообщение
- `ack` - Подтверждение отправки
- `ping` - Heartbeat запрос

## Особенности

### Автоматическое переподключение

При потере соединения автоматически выполняется до 5 попыток переподключения с интервалом 3 секунды.

### Heartbeat

Каждые 3 секунды сервер отправляет ping. Клиент должен ответить любым сообщением в течение 9 секунд.

### Retry механизм

Если сообщение не подтверждено в течение 9 секунд, сервер отправляет push-уведомление.

### Offline сообщения

При подключении пользователь автоматически получает все непрочитанные сообщения.

## Интеграция с Auth

Модуль автоматически интегрирован с auth store:

- **При входе**: WebSocket инициализируется после `getProfile()`
- **При выходе**: WebSocket отключается в методе `logout()`
- **ID пользователя**: Автоматически берется из `authStore.user.id`

## Безопасность

- JWT токен передается через query параметр при установке WebSocket соединения
- Токен берется из cookies (`access_token`)
- Все сообщения отправляются только авторизованным пользователям

